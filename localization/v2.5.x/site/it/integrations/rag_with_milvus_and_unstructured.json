{"codeList":["$ pip install -qU \"unstructured-ingest[pdf]\" unstructured pymilvus openai\n","import os\n\n\nos.environ[\"UNSTRUCTURED_API_KEY\"] = \"***********\"\nos.environ[\"UNSTRUCTURED_URL\"] = \"***********\"\n\nos.environ[\"OPENAI_API_KEY\"] = \"***********\"\n","from pymilvus import MilvusClient, DataType\n\n# Initialize Milvus client\nmilvus_client = MilvusClient(uri=\"./milvus_demo.db\")  # TODO\n","collection_name = \"my_rag_collection\"\n\nif milvus_client.has_collection(collection_name):\n    milvus_client.drop_collection(collection_name)\n","from openai import OpenAI\n\nopenai_client = OpenAI()\n\n\ndef emb_text(text):\n    return (\n        openai_client.embeddings.create(input=text, model=\"text-embedding-3-small\")\n        .data[0]\n        .embedding\n    )\n","test_embedding = emb_text(\"This is a test\")\nembedding_dim = len(test_embedding)\nprint(embedding_dim)\nprint(test_embedding[:10])\n","# Create schema\nschema = milvus_client.create_schema(auto_id=False, enable_dynamic_field=False)\n# Add fields to schema\nschema.add_field(field_name=\"id\", datatype=DataType.INT64, is_primary=True)\nschema.add_field(field_name=\"vector\", datatype=DataType.FLOAT_VECTOR, dim=embedding_dim)\nschema.add_field(field_name=\"text\", datatype=DataType.VARCHAR, max_length=65535)\nschema.add_field(field_name=\"metadata\", datatype=DataType.JSON)\nindex_params = MilvusClient.prepare_index_params()\nindex_params.add_index(\n    field_name=\"vector\",\n    metric_type=\"COSINE\",\n    index_type=\"AUTOINDEX\",\n)\nmilvus_client.create_collection(\n    collection_name=collection_name,\n    schema=schema,\n    index_params=index_params,\n    consistency_level=\"Strong\",\n)\n\nmilvus_client.load_collection(collection_name=collection_name)\n","from unstructured_ingest.v2.pipeline.pipeline import Pipeline\nfrom unstructured_ingest.v2.interfaces import ProcessorConfig\nfrom unstructured_ingest.v2.processes.connectors.local import (\n    LocalIndexerConfig,\n    LocalDownloaderConfig,\n    LocalConnectionConfig,\n    LocalUploaderConfig,\n)\nfrom unstructured_ingest.v2.processes.partitioner import PartitionerConfig\n\ndirectory_with_pdfs = \"./pdf_files\"\ndirectory_with_results = \"./pdf_processed_outputs\"\n\nPipeline.from_configs(\n    context=ProcessorConfig(),\n    indexer_config=LocalIndexerConfig(input_path=directory_with_pdfs),\n    downloader_config=LocalDownloaderConfig(),\n    source_connection_config=LocalConnectionConfig(),\n    partitioner_config=PartitionerConfig(\n        partition_by_api=True,\n        api_key=os.getenv(\"UNSTRUCTURED_API_KEY\"),\n        partition_endpoint=os.getenv(\"UNSTRUCTURED_API_URL\"),\n        strategy=\"hi_res\",\n        additional_partition_args={\n            \"split_pdf_page\": True,\n            \"split_pdf_concurrency_level\": 15,\n        },\n    ),\n    uploader_config=LocalUploaderConfig(output_dir=directory_with_results),\n).run()\n\n\nfrom unstructured.staging.base import elements_from_json\n\n\ndef load_processed_files(directory_path):\n    elements = []\n    for filename in os.listdir(directory_path):\n        if filename.endswith(\".json\"):\n            file_path = os.path.join(directory_path, filename)\n            try:\n                elements.extend(elements_from_json(filename=file_path))\n            except IOError:\n                print(f\"Error: Could not read file {filename}.\")\n\n    return elements\n\n\nelements = load_processed_files(directory_with_results)\n","data = []\nfor i, element in enumerate(elements):\n    data.append(\n        {\n            \"id\": i,\n            \"vector\": emb_text(element.text),\n            \"text\": element.text,\n            \"metadata\": element.metadata.to_dict(),\n        }\n    )\nmilvus_client.insert(collection_name=collection_name, data=data)\n","def retrieve_documents(question, top_k=3):\n    search_res = milvus_client.search(\n        collection_name=collection_name,\n        data=[emb_text(question)],\n        limit=top_k,\n        # search_params={\"metric_type\": \"IP\", \"params\": {}},\n        output_fields=[\"text\"],\n    )\n    return [(res[\"entity\"][\"text\"], res[\"distance\"]) for res in search_res[0]]\n","def generate_rag_response(question):\n    retrieved_docs = retrieve_documents(question)\n    context = \"\\n\".join([f\"Text: {doc[0]}\\n\" for doc in retrieved_docs])\n    system_prompt = (\n        \"You are an AI assistant. Provide answers based on the given context.\"\n    )\n    user_prompt = f\"\"\"\n    Use the following pieces of information to answer the question. If the information is not in the context, say you don't know.\n    \n    Context:\n    {context}\n    \n    Question: {question}\n    \"\"\"\n    response = openai_client.chat.completions.create(\n        model=\"gpt-4o-mini\",\n        messages=[\n            {\"role\": \"system\", \"content\": system_prompt},\n            {\"role\": \"user\", \"content\": user_prompt},\n        ],\n    )\n    return response.choices[0].message.content\n","question = \"What is the Advanced Search Algorithms in Milvus?\"\nanswer = generate_rag_response(question)\nprint(f\"Question: {question}\")\nprint(f\"Answer: {answer}\")\n"],"headingContent":"Build a RAG with Milvus and Unstructured","anchorList":[{"label":"Build a RAG with Milvus and Unstructured","href":"Build-a-RAG-with-Milvus-and-Unstructured","type":1,"isActive":false},{"label":"Preparation","href":"Preparation","type":2,"isActive":false},{"label":"Create Milvus Collection","href":"Create-Milvus-Collection","type":2,"isActive":false},{"label":"Load data from Unstructured","href":"Load-data-from-Unstructured","type":2,"isActive":false},{"label":"Retrieve and Generate Response","href":"Retrieve-and-Generate-Response","type":2,"isActive":false}]}
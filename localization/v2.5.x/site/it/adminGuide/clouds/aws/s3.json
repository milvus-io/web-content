{"codeList":["milvus_bucket_name=\"milvus-bucket-$(openssl rand -hex 12)\"\n\naws s3api create-bucket --bucket \"$milvus_bucket_name\" --region 'us-east-2' --acl private  --object-ownership ObjectWriter --create-bucket-configuration LocationConstraint='us-east-2'\n\n\n# Output\n#\n# \"Location\": \"http://milvus-bucket-039dd013c0712f085d60e21f.s3.amazonaws.com/\"\n","echo '{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:ListBucket\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::<bucket-name>\"\n      ]\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:DeleteObject\",\n        \"s3:GetObject\",\n        \"s3:PutObject\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::<bucket-name>/*\"\n      ]\n    }\n  ]\n}' > milvus-s3-policy.json\n\naws iam create-policy --policy-name MilvusS3ReadWrite --policy-document file://milvus-s3-policy.json\n\n\n# Get the ARN from the command output as follows:\n# {\n#     \"Policy\": {\n#         \"PolicyName\": \"MilvusS3ReadWrite\",\n#         \"PolicyId\": \"AN5QQVVPM1BVTFlBNkdZT\",\n#         \"Arn\": \"arn:aws:iam::12345678901:policy/MilvusS3ReadWrite\",\n#         \"Path\": \"/\",\n#         \"DefaultVersionId\": \"v1\",\n#         \"AttachmentCount\": 0,\n#         \"PermissionsBoundaryUsageCount\": 0,\n#         \"IsAttachable\": true,\n#         \"CreateDate\": \"2023-11-16T06:00:01+00:00\",\n#        \"UpdateDate\": \"2023-11-16T06:00:01+00:00\"\n#     }\n# }    \n","eksctl create iamserviceaccount --name milvus-s3-access-sa --namespace milvus --cluster milvus-eks-cluster --role-name milvus-s3-access-sa \\\n    --attach-policy-arn arn:aws:iam::<your-account-id>:policy/MilvusS3ReadWrite --approve\n","aws iam get-role --role-name milvus-s3-access-sa --query Role.AssumeRolePolicyDocument\n# An example output is as follows\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"Federated\": \"arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE\"\n            },\n            \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n            \"Condition\": {\n                \"StringEquals\": {\n                    \"oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:sub\": \"system:serviceaccount:default:my-service-account\",\n                    \"oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:aud\": \"sts.amazonaws.com\"\n                }\n            }\n        }\n    ]\n}\n","aws iam list-attached-role-policies --role-name milvus-s3-access-sa --query 'AttachedPolicies[].PolicyArn' --output text\n# An example output is as follows\narn:aws:iam::12345678901:policy/MilvusS3ReadWrite\n","export policy_arn='arn:aws:iam::12345678901:policy/MilvusS3ReadWrite'\naws iam get-policy --policy-arn $policy_arn\n# An example output is as follows\n{\n    \"Policy\": {\n        \"PolicyName\": \"MilvusS3ReadWrite\",\n        \"PolicyId\": \"EXAMPLEBIOWGLDEXAMPLE\",\n        \"Arn\": \"arn:aws:iam::12345678901:policy/MilvusS3ReadWrite\",\n        \"Path\": \"/\",\n        \"DefaultVersionId\": \"v2\",\n        [...]\n    }\n}\n","aws iam get-policy-version --policy-arn $policy_arn --version-id v2\n# An example output is as follows\n{\n    \"PolicyVersion\": {\n        \"Document\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Effect\": \"Allow\",\n                    \"Action\": [\n                        \"s3:GetObject\",\n                        \"s3:PutObject\",\n                        \"s3:ListBucket\",\n                        \"s3:DeleteObject\"\n                    ],\n                    \"Resource\": [\n                        \"arn:aws:s3:::<bucket-name>\",\n                        \"arn:aws:s3:::<bucket-name>/*\"\n                    ]\n                }\n            ]\n        },\n        [...]\n    }\n}\n","kubectl describe serviceaccount milvus-s3-access-sa -n milvus\n# An example output is as follows\nName:                milvus-s3-access-sa\nNamespace:           milvus\nLabels:              app.kubernetes.io/managed-by=eksctl\nAnnotations:         eks.amazonaws.com/role-arn: arn:aws:iam::12345678901:role/milvus-s3-access-sa\n[...]\n","helm repo add milvus https://zilliztech.github.io/milvus-helm/\nhelm repo update\n","cluster:\n  enabled: true\n\nservice:\n  type: LoadBalancer\n  port: 19530\n  annotations: \n    service.beta.kubernetes.io/aws-load-balancer-type: external\n    service.beta.kubernetes.io/aws-load-balancer-name: milvus-service\n    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing\n    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip\n\nserviceAccount:\n  create: false\n  name: milvus-s3-access-sa\n\nminio:\n  enabled: false\n\nexternalS3:\n  enabled: true\n  host: \"s3.us-east-2.amazonaws.com\"\n  port: \"443\"\n  useSSL: true\n  bucketName: \"<bucket-name>\"\n  useIAM: true\n  cloudProvider: \"aws\"\n  iamEndpoint: \"\"\n\nrootCoordinator:\n  replicas: 2\n  activeStandby:\n    enabled: true\n  resources: \n    limits:\n      cpu: 1\n      memory: 2Gi\n\nindexCoordinator:\n  replicas: 2\n  activeStandby:\n    enabled: true\n  resources: \n    limits:\n      cpu: \"0.5\"\n      memory: 0.5Gi\n\nqueryCoordinator:\n  replicas: 2\n  activeStandby:\n    enabled: true\n  resources: \n    limits:\n      cpu: \"0.5\"\n      memory: 0.5Gi\n\ndataCoordinator:\n  replicas: 2\n  activeStandby:\n    enabled: true\n  resources: \n    limits:\n      cpu: \"0.5\"\n      memory: 0.5Gi\n\nproxy:\n  replicas: 2\n  resources: \n    limits:\n      cpu: 1\n      memory: 2Gi  \n","helm upgrade --install milvus-demo milvus/milvus -n milvus -f milvus.yaml\n"],"headingContent":"Configure S3 Access by IAM Role","anchorList":[{"label":"Configure S3 Access by IAM Role","href":"Configure-S3-Access-by-IAM-Role","type":1,"isActive":false},{"label":"Before you start","href":"Before-you-start","type":2,"isActive":false},{"label":"Associate an IAM role with a Kubernetes service account","href":"Associate-an-IAM-role-with-a-Kubernetes-service-account","type":2,"isActive":false},{"label":"Verify the role and service account setup","href":"Verify-the-role-and-service-account-setup","type":2,"isActive":false},{"label":"Deploy Milvus","href":"Deploy-Milvus","type":2,"isActive":false},{"label":"Verify the installation","href":"Verify-the-installation","type":2,"isActive":false}]}
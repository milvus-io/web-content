{"codeList":["pip install pymilvus cohere pandas numpy tqdm\n","import cohere\nimport pandas\nimport numpy as np\nfrom tqdm import tqdm\nfrom pymilvus import connections, FieldSchema, CollectionSchema, DataType, Collection, utility\n","FILE = 'https://rajpurkar.github.io/SQuAD-explorer/dataset/train-v2.0.json'  # The SQuAD dataset url\nCOLLECTION_NAME = 'question_answering_db'  # Collection name\nDIMENSION = 1024  # Embeddings size, cohere embeddings default to 4096 with the large model\nCOUNT = 5000  # How many questions to embed and insert into Milvus\nBATCH_SIZE = 96 # How large of batches to use for embedding and insertion\nMILVUS_HOST = 'localhost'  # Milvus server URI\nMILVUS_PORT = '19530'\nCOHERE_API_KEY = 'replace-this-with-the-cohere-api-key'  # API key obtained from Cohere\n","# Download the dataset\ndataset = pandas.read_json(FILE)\n\n# Clean up the dataset by grabbing all the question answer pairs\nsimplified_records = []\nfor x in dataset['data']:\n    for y in x['paragraphs']:\n        for z in y['qas']:\n            if len(z['answers']) != 0:\n                simplified_records.append({'question': z['question'], 'answer': z['answers'][0]['text']})\n\n# Grab the amount of records based on COUNT\nsimplified_records = pandas.DataFrame.from_records(simplified_records)\nsimplified_records = simplified_records.sample(n=min(COUNT, len(simplified_records)), random_state = 42)\n\n# Check the length of the cleaned dataset matches count\nprint(len(simplified_records))\n","5000\n","# Connect to Milvus Database\nconnections.connect(host=MILVUS_HOST, port=MILVUS_PORT)\n\n# Remove collection if it already exists\nif utility.has_collection(COLLECTION_NAME):\n    utility.drop_collection(COLLECTION_NAME)\n\n# Create collection which includes the id, title, and embedding.\nfields = [\n    FieldSchema(name='id', dtype=DataType.INT64, is_primary=True, auto_id=True),\n    FieldSchema(name='original_question', dtype=DataType.VARCHAR, max_length=1000),\n    FieldSchema(name='answer', dtype=DataType.VARCHAR, max_length=1000),\n    FieldSchema(name='original_question_embedding', dtype=DataType.FLOAT_VECTOR, dim=DIMENSION)\n]\nschema = CollectionSchema(fields=fields)\ncollection = Collection(name=COLLECTION_NAME, schema=schema)\n\n# Create an IVF_FLAT index for collection.\nindex_params = {\n    'metric_type':'IP',\n    'index_type':\"IVF_FLAT\",\n    'params':{\"nlist\": 1024}\n}\ncollection.create_index(field_name=\"original_question_embedding\", index_params=index_params)\ncollection.load()\n","# Set up a co:here client.\ncohere_client = cohere.Client(COHERE_API_KEY)\n\n# Extract embeddings from questions using Cohere\ndef embed(texts, input_type):\n    res = cohere_client.embed(texts, model='embed-multilingual-v3.0', input_type=input_type)\n    return res.embeddings\n\n# Insert each question, answer, and qustion embedding\ntotal = pandas.DataFrame()\nfor batch in tqdm(np.array_split(simplified_records, (COUNT/BATCH_SIZE) + 1)):\n    questions = batch['question'].tolist()\n    embeddings = embed(questions, \"search_document\")\n    \n    data = [\n        {\n            'original_question': x,\n            'answer': batch['answer'].tolist()[i],\n            'original_question_embedding': embeddings[i]\n        } for i, x in enumerate(questions)\n    ]\n\n    collection.insert(data=data)\n\ntime.sleep(10)\n","# Search the cluster for an answer to a question text\ndef search(text, top_k = 5):\n\n    # AUTOINDEX does not require any search params \n    search_params = {}\n\n    results = collection.search(\n        data = embed([text], \"search_query\"),  # Embeded the question\n        anns_field='original_question_embedding',\n        param=search_params,\n        limit = top_k,  # Limit to top_k results per search\n        output_fields=['original_question', 'answer']  # Include the original question and answer in the result\n    )\n\n    distances = results[0].distances\n    entities = [ x.entity.to_dict()['entity'] for x in results[0] ]\n\n    ret = [ {\n        \"answer\": x[1][\"answer\"],\n        \"distance\": x[0],\n        \"original_question\": x[1]['original_question']\n    } for x in zip(distances, entities)]\n\n    return ret\n\n# Ask these questions\nsearch_questions = ['What kills bacteria?', 'What\\'s the biggest dog?']\n\n# Print out the results in order of [answer, similarity score, original question]\n\nret = [ { \"question\": x, \"candidates\": search(x) } for x in search_questions ]\n","# Output\n#\n# [\n#     {\n#         \"question\": \"What kills bacteria?\",\n#         \"candidates\": [\n#             {\n#                 \"answer\": \"farming\",\n#                 \"distance\": 0.6261022090911865,\n#                 \"original_question\": \"What makes bacteria resistant to antibiotic treatment?\"\n#             },\n#             {\n#                 \"answer\": \"Phage therapy\",\n#                 \"distance\": 0.6093736886978149,\n#                 \"original_question\": \"What has been talked about to treat resistant bacteria?\"\n#             },\n#             {\n#                 \"answer\": \"oral contraceptives\",\n#                 \"distance\": 0.5902313590049744,\n#                 \"original_question\": \"In therapy, what does the antibacterial interact with?\"\n#             },\n#             {\n#                 \"answer\": \"slowing down the multiplication of bacteria or killing the bacteria\",\n#                 \"distance\": 0.5874154567718506,\n#                 \"original_question\": \"How do antibiotics work?\"\n#             },\n#             {\n#                 \"answer\": \"in intensive farming to promote animal growth\",\n#                 \"distance\": 0.5667208433151245,\n#                 \"original_question\": \"Besides in treating human disease where else are antibiotics used?\"\n#             }\n#         ]\n#     },\n#     {\n#         \"question\": \"What's the biggest dog?\",\n#         \"candidates\": [\n#             {\n#                 \"answer\": \"English Mastiff\",\n#                 \"distance\": 0.7875324487686157,\n#                 \"original_question\": \"What breed was the largest dog known to have lived?\"\n#             },\n#             {\n#                 \"answer\": \"forest elephants\",\n#                 \"distance\": 0.5886962413787842,\n#                 \"original_question\": \"What large animals reside in the national park?\"\n#             },\n#             {\n#                 \"answer\": \"Rico\",\n#                 \"distance\": 0.5634892582893372,\n#                 \"original_question\": \"What is the name of the dog that could ID over 200 things?\"\n#             },\n#             {\n#                 \"answer\": \"Iditarod Trail Sled Dog Race\",\n#                 \"distance\": 0.546872615814209,\n#                 \"original_question\": \"Which dog-sled race in Alaska is the most famous?\"\n#             },\n#             {\n#                 \"answer\": \"part of the family\",\n#                 \"distance\": 0.5387814044952393,\n#                 \"original_question\": \"Most people today describe their dogs as what?\"\n#             }\n#         ]\n#     }\n# ]\n\n"],"headingContent":"Question Answering Using Milvus and Cohere","anchorList":[{"label":"Question Answering Using Milvus and Cohere","href":"Question-Answering-Using-Milvus-and-Cohere","type":1,"isActive":false},{"label":"Before you begin","href":"Before-you-begin","type":2,"isActive":false},{"label":"Parameters","href":"Parameters","type":2,"isActive":false},{"label":"Prepare the dataset","href":"Prepare-the-dataset","type":2,"isActive":false},{"label":"Create a collection","href":"Create-a-collection","type":2,"isActive":false},{"label":"Insert data","href":"Insert-data","type":2,"isActive":false},{"label":"Ask questions","href":"Ask-questions","type":2,"isActive":false}]}
{"codeList":["pip install --upgrade huggingface-hub transformers datasets pymilvus cohere\n","from datasets import load_dataset\n\nlang = \"simple\"\ndocs = load_dataset(\n    \"Cohere/wikipedia-2023-11-embed-multilingual-v3\", \n    lang, \n    split=\"train[:10000]\"\n)\n","df = docs.to_pandas()\ngroups = df.groupby('title')\n\ndata = []\n\nfor title, group in groups:\n  data.append({\n      \"title\": title,\n      \"paragraphs\": [{\n          \"text\": row['text'],\n          'emb': row['emb']\n      } for _, row in group.iterrows()]\n  })\n","from pymilvus import MilvusClient, DataType\n\nclient = MilvusClient(\n    uri=\"http://localhost:19530\",\n    token=\"root:Milvus\"\n)\n\n# Create collection schema\nschema = client.create_schema()\n\nschema.add_field('id', DataType.INT64, is_primary=True, auto_id=True)\nschema.add_field('title', DataType.VARCHAR, max_length=512)\n\n# Create struct schema\nstruct_schema = client.create_struct_field_schema()\nstruct_schema.add_field('text', DataType.VARCHAR, max_length=65535)\nstruct_schema.add_field('emb', DataType.FLOAT_VECTOR, dim=512)\n\nschema.add_field('paragraphs', DataType.ARRAY,\n                 element_type=DataType.STRUCT,\n                 struct_schema=struct_schema, max_capacity=200)\n\n# Create index parameters\nindex_params = client.prepare_index_params()\nindex_params.add_index(\n    field_name=\"paragraphs[emb]\",\n    index_type=\"AUTOINDEX\",\n    metric_type=\"MAX_SIM_COSINE\"\n)\n\n# Create a collection\nclient.create_collection(\n    collection_name='wiki_documents', \n    schema=schema, \n    index_params=index_params\n)\n","client.insert(\n    collection_name='wiki_documents', \n    data=data\n)\n","import cohere\n\nco = cohere.ClientV2(\"COHERE_API_KEY\")\n\nquery_inputs = [\n    {\n        'content': [\n            {'type': 'text', 'text': 'Adobe'},\n        ]\n    },\n    {\n        'content': [\n            {'type': 'text', 'text': 'software'}\n        ]\n    }\n]\n\nembeddings = co.embed(\n    inputs=query_inputs,\n    model='embed-multilingual-v3.0',\n    input_type=\"classification\",\n    embedding_types=[\"float\"],\n)\n","from pymilvus.client.embedding_list import EmbeddingList\n\nquery_emb_list = EmbeddingList()\n\nif (embeddings.embeddings.float):\n  query_emb_list.add_batch(embeddings.embeddings.float)\n\nresults = client.search(\n    collection_name=\"wiki_documents\",\n    data=[query_emb_list],\n    anns_field=\"paragraphs[emb]\",\n    search_params={\n        \"metric_type\": \"MAX_SIM_COSINE\"\n    },\n    limit=10,\n    output_fields=[\"title\"]\n)\n\nfor hit in results[0]:\n  print(f\"Document {hit['entity']['title']}: {hit['distance']:.4f}\")\n","# Document Software: 2.3035\n# Document Application: 2.1875\n# Document Adobe Illustrator: 2.1167\n# Document Open source: 2.0542\n# Document Computer: 1.9811\n# Document Microsoft: 1.9784\n# Document Web browser: 1.9655\n# Document Program: 1.9627\n# Document Website: 1.9594\n# Document Computer science: 1.9460\n","pip install --upgrade huggingface-hub transformers datasets pymilvus 'colpali-engine>=0.3.0,<0.4.0'\n","from datasets import load_dataset\n\nds = load_dataset(\"vidore/vidore_v3_finance_en\", \"corpus\")\ndf = ds['test'].to_pandas()\n","import torch\nfrom typing import cast\nfrom colpali_engine.models import ColPali, ColPaliProcessor\n\nmodel_name = \"vidore/colpali-v1.3\"\n\nmodel = ColPali.from_pretrained(\n    model_name,\n    torch_dtype=torch.bfloat16,\n    device_map=\"cuda:0\",  # or \"mps\" if on Apple Silicon\n).eval()\n\nprocessor = ColPaliProcessor.from_pretrained(model_name)\n","from PIL import Image\nfrom io import BytesIO\n\n# Use the iterrow() generator to get the first row\nrow = next(df.iterrows())[1]\n\n# Include the image in the above row in a list\nimages = [ Image.open(row['image']['bytes'] ]\npatches = processor.process_images(images).to(model.device)\npatches_embeddings = model(**patches_in_pixels)[0]\n\n# Check the shape of the embeddings generated for the patches\nprint(patches_embeddings.shape)\n\n# [1031, 128]\n","data = []\n\nfor index, row in df.iterrows():\n  row = next(df.iterrows())[1]\n  corpus_id = row['corpus_id']\n  \n  images = [Image.open(BytesIO(row['image']['bytes']))]\n  batch_images = processor.process_images(images).to(model.device)\n  patches = model(**batch_images)[0]\n\n  doc_id = row['doc_id']\n  markdown = row['markdown']\n  page_number_in_doc = row['page_number_in_doc']\n\n  data.append({\n      \"corpus_id\": corpus_id,\n      \"patches\": [ {\"emb\": emb} for emb in patches ],\n      \"doc_id\": markdown,\n      \"page_number_in_doc\": row['page_number_in_doc']\n  })\n","from pymilvus import MilvusClient, DataType\n\nclient = MilvusClient(\n    uri=YOUR_CLUSTER_ENDPOINT,\n    token=YOUR_API_KEY\n)\n\nschema = client.create_schema()\n\nschema.add_field(\n    field_name=\"corpus_id\",\n    datatype=DataType.INT64,\n    is_primary=True\n)\n\npatch_schema = client.create_struct_field_schema()\n\npatch_schema.add_field(\n    field_name=\"emb\",\n    datatype=DataType.FLOAT_VECTOR,\n    dim=128\n)\n\nschema.add_field(\n    field_name=\"patches\",\n    datatype=DataType.ARRAY,\n    element_type=DataType.STRUCT,\n    struct_schema=patch_schema,\n    max_capacity=1031\n)\n\nschema.add_field(\n    field_name=\"doc_id\",\n    datatype=DataType.VARCHAR,\n    max_length=512\n)\n\nschema.add_field(\n    field_name=\"page_number_in_doc\",\n    datatype=DataType.INT64\n)\n\nindex_params = client.prepare_index_params()\n\nindex_params.add_index(\n    field_name=\"patches[emb]\",\n    index_type=\"AUTOINDEX\",\n    metric_type=\"MAX_SIM_COSINE\"\n)\n\nclient.create_collection(\n    collection_name=\"financial_reports\",\n    schema=schema,\n    index_params=index_params\n)\n","client.insert(\n    collection_name=\"financial_reports\",\n    data=data\n)\n","from pymilvus.client.embedding_list import EmbeddingList\n\nqueries = [\n    \"quarterly revenue growth chart\"\n]\n\nbatch_queries = processor.process_queries(queries).to(model.device)\n\nwith torch.no_grad():\n  query_embeddings = model(**batch_queries)\n\nquery_emb_list = EmbeddingList()\nquery_emb_list.add_batch(query_embeddings[0].cpu())\n\nresults = client.search(\n    collection_name=\"financial_reports\",\n    data=[query_emb_list],\n    anns_field=\"patches[emb]\",\n    search_params={\n        \"metric_type\": \"MAX_SIM_COSINE\"\n    },\n    limit=10,\n    output_fields=[\"doc_id\", \"page_number_in_doc\"]\n)\n\n"],"headingContent":"Search with Embedding Lists","anchorList":[{"label":"Ricerca con elenchi incorporati","href":"Search-with-Embedding-Lists","type":1,"isActive":false},{"label":"Panoramica","href":"Overview","type":2,"isActive":false},{"label":"Codifica per token","href":"Token-wise-encoding","type":3,"isActive":false},{"label":"Interazione tardiva","href":"Late-interaction","type":3,"isActive":false},{"label":"Estensione ColPali","href":"ColPali-extension","type":3,"isActive":false},{"label":"Sistema di recupero del testo ColBERT","href":"ColBERT-text-retrieval-system","type":2,"isActive":false},{"label":"Passo 1: installare le dipendenze","href":"Step-1-Install-the-dependencies","type":3,"isActive":false},{"label":"Passo 2: caricare il set di dati Cohere","href":"Step-2-Load-the-Cohere-dataset","type":3,"isActive":false},{"label":"Passo 3: raggruppare i paragrafi per titolo","href":"Step-3-Group-paragraphs-by-title","type":3,"isActive":false},{"label":"Passo 4: Creare una raccolta per il set di dati Cohere","href":"Step-4-Create-a-collection-for-the-Cohere-dataset","type":3,"isActive":false},{"label":"Passo 5: Inserire il set di dati Cohere nella raccolta","href":"Step-5-Insert-Cohere-dataset-into-the-collection","type":3,"isActive":false},{"label":"Passo 6: Ricerca all'interno del set di dati Cohere","href":"Step-6-Search-within-the-Cohere-dataset","type":3,"isActive":false},{"label":"Sistema di recupero del testo ColPali","href":"ColPali-text-retrieval-system","type":2,"isActive":false},{"label":"Passo 1: installare le dipendenze","href":"Step-1-Install-the-dependencies","type":3,"isActive":false},{"label":"Passo 2: Caricare il dataset Vidore","href":"Step-2-Load-the-Vidore-dataset","type":3,"isActive":false},{"label":"Fase 3: Generare le incorporazioni per le immagini delle pagine","href":"Step-3-Generate-embeddings-for-the-page-images","type":3,"isActive":false},{"label":"Fase 4: Creare una raccolta per il set di dati dei rapporti finanziari","href":"Step-4-Create-a-collection-for-the-financial-reports-dataset","type":3,"isActive":false},{"label":"Passo 5: inserire i rapporti finanziari nella collezione","href":"Step-5-Insert-the-financial-reports-into-the-collection","type":3,"isActive":false},{"label":"Fase 6: Ricerca all'interno dei rapporti finanziari","href":"Step-6-Search-within-the-financial-reports","type":3,"isActive":false}]}
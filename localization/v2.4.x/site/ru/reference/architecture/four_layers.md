---
id: four_layers.md
summary: Структура разделения хранения и вычислений в Milvus.
title: Дезагрегация систем хранения данных и вычислений
---
<h1 id="StorageComputing-Disaggregation" class="common-anchor-header">Дезагрегация систем хранения данных и вычислений<button data-href="#StorageComputing-Disaggregation" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h1><p>Следуя принципу дезагрегации плоскости данных и плоскости управления, Milvus состоит из четырех уровней, которые являются взаимно независимыми с точки зрения масштабируемости и аварийного восстановления.</p>
<h2 id="Access-layer" class="common-anchor-header">Уровень доступа<button data-href="#Access-layer" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Состоящий из группы прокси-серверов без статического управления, уровень доступа является передним уровнем системы и конечной точкой для пользователей. Он проверяет запросы клиентов и сокращает возвращаемые результаты:</p>
<ul>
<li>Прокси сам по себе не имеет статусов. Он предоставляет единый адрес сервиса, используя компоненты балансировки нагрузки, такие как Nginx, Kubernetes Ingress, NodePort и LVS.</li>
<li>Поскольку в Milvus используется архитектура массивно-параллельной обработки (MPP), прокси агрегирует и обрабатывает промежуточные результаты, прежде чем вернуть клиенту окончательные результаты.</li>
</ul>
<h2 id="Coordinator-service" class="common-anchor-header">Служба координатора<button data-href="#Coordinator-service" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Служба-координатор распределяет задачи между рабочими узлами и выполняет функции "мозга" системы. Среди задач, которые он берет на себя, - управление топологией кластера, балансировка нагрузки, генерация временных меток, объявление данных и управление данными.</p>
<p>Существует три типа координаторов: корневой координатор (root coord), координатор данных (data coord) и координатор запросов (query coord).</p>
<h3 id="Root-coordinator-root-coord" class="common-anchor-header">Корневой координатор (root coord)</h3><p>Корневой координатор обрабатывает запросы языка определения данных (DDL) и языка управления данными (DCL), такие как создание или удаление коллекций, разделов или индексов, а также управляет выдачей TSO (timestamp Oracle) и временных тикеров.</p>
<h3 id="Query-coordinator-query-coord" class="common-anchor-header">Координатор запросов (query coord)</h3><p>Query coord управляет топологией и балансировкой нагрузки для узлов запросов, а также передает запросы от растущих сегментов к уплотненным сегментам.</p>
<h3 id="Data-coordinator-data-coord" class="common-anchor-header">Координатор данных (data coord)</h3><p>Координатор данных управляет топологией узлов данных и узлов индекса, поддерживает метаданные, запускает операции промывки, уплотнения, создания индекса и другие фоновые операции с данными.</p>
<h2 id="Worker-nodes" class="common-anchor-header">Рабочие узлы<button data-href="#Worker-nodes" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Рабочие узлы - это "немые" исполнители, которые следуют инструкциям службы координатора и выполняют команды языка манипулирования данными (DML), поступающие от прокси. Рабочие узлы не имеют статусов благодаря разделению хранения и вычислений и могут способствовать масштабированию системы и аварийному восстановлению при развертывании на Kubernetes. Существует три типа рабочих узлов:</p>
<h3 id="Query-node" class="common-anchor-header">Узел запросов</h3><p>Узлы запросов получают инкрементные данные журнала и превращают их в растущие сегменты, подписываясь на брокера журналов, загружают исторические данные из объектного хранилища и выполняют гибридный поиск между векторными и скалярными данными.</p>
<h3 id="Data-node" class="common-anchor-header">Узел данных</h3><p>Узлы данных получают инкрементные данные журнала, подписываясь на брокера журнала, обрабатывают запросы на мутацию, упаковывают данные журнала в снимки журнала и сохраняют их в объектном хранилище.</p>
<h3 id="Index-node" class="common-anchor-header">Индексный узел</h3><p>Индексные узлы строят индексы. Они не должны занимать память и могут быть реализованы с помощью бессерверного фреймворка.</p>
<h2 id="Storage" class="common-anchor-header">Хранилище<button data-href="#Storage" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Хранилище - это костяк системы, отвечающий за сохранность данных. Оно включает в себя метахранилище, лог-брокер и хранилище объектов.</p>
<h3 id="Meta-storage" class="common-anchor-header">Метахранилище</h3><p>Метахранилище хранит снимки метаданных, таких как схема коллекции и контрольные точки потребления сообщений. Хранение метаданных требует чрезвычайно высокой доступности, высокой согласованности и поддержки транзакций, поэтому Milvus выбрал для этих целей etcd. Milvus также использует etcd для регистрации сервисов и проверки их работоспособности.</p>
<h3 id="Object-storage" class="common-anchor-header">Объектное хранилище</h3><p>В объектном хранилище хранятся файлы моментальных снимков журналов, индексные файлы для скалярных и векторных данных, а также промежуточные результаты запросов. Milvus использует MinIO в качестве объектного хранилища и может быть легко развернуто на AWS S3 и Azure Blob, двух самых популярных и экономичных сервисах хранения данных в мире. Однако объектное хранилище имеет высокую задержку доступа и тарифицируется по количеству запросов. Для повышения производительности и снижения затрат Milvus планирует реализовать разделение данных по принципу "холодный-горячий" в пуле кэша на базе памяти или SSD.</p>
<h3 id="Log-broker" class="common-anchor-header">Брокер журналов</h3><p>Брокер журналов - это система pub-sub, поддерживающая воспроизведение. Он отвечает за сохранение потоковых данных и уведомление о событиях. Он также обеспечивает целостность инкрементных данных при восстановлении рабочих узлов после сбоев в системе. В Milvus Distributed в качестве лог-брокера используется Pulsar, а в Milvus Standalone - RocksDB. Лог-брокер может быть легко заменен платформами для хранения потоковых данных, такими как Kafka.</p>
<p>Milvus следует принципу "журнал как данные", поэтому Milvus не поддерживает физическую таблицу, но гарантирует надежность данных за счет персистентности логов и журналов моментальных снимков.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="/docs/v2.4.x/assets/log_mechanism.png" alt="Log_mechanism" class="doc-image" id="log_mechanism" />
   </span> <span class="img-wrapper"> <span>Механизм ведения журнала</span> </span></p>
<p>Брокер журналов является основой Milvus. Благодаря встроенному механизму pub-sub он отвечает за сохранение данных и разделение их на чтение и запись. На рисунке выше показано упрощенное изображение механизма, где система разделена на две роли - брокера журналов (для поддержания последовательности журналов) и подписчика журналов. Первый регистрирует все операции, изменяющие состояние коллекции; второй подписывается на последовательность журналов для обновления локальных данных и предоставляет услуги в виде копий, доступных только для чтения. Механизм pub-sub также позволяет расширить систему в плане сбора данных об изменениях (CDC) и глобально-распределенного развертывания.</p>
<h2 id="Whats-next" class="common-anchor-header">Что дальше<button data-href="#Whats-next" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><ul>
<li>Для получения более подробной информации об архитектуре Milvus читайте <a href="/docs/ru/v2.4.x/main_components.md">раздел Основные компоненты</a>.</li>
</ul>
